name: React Frontend CI/CD

on:
  workflow_call:
    inputs:
      app-name:
        description: 'Name of the application (e.g., tripalta-ui)'
        required: true
        type: string
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'
      enable-slack-notifications:
        description: 'Whether to send Slack notifications'
        required: false
        type: boolean
        default: false

concurrency:
  group: react-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Check Formatting (Prettier)
        run: npm run format:check || npx prettier --check .

      - name: Lint (ESLint)
        run: npm run lint

      - name: Type Check (TypeScript)
        run: npm run type-check

      - name: Run Unit Tests
        run: npm run test -- --passWithNoTests --coverage || true

      - name: Build Application
        run: npm run build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ inputs.app-name }}
          path: dist/
          retention-days: 7

  deploy-staging:
    name: Deploy to Staging
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: staging
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build for Staging
        run: npm run build
        env:
          VITE_API_BASE_URL: https://stg-api.tripalta.com
          VITE_ENVIRONMENT: staging

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/tripalta-staging/${{ inputs.app-name }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/tripalta-staging/${{ inputs.app-name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster tripalta-staging-cluster \
            --service ${{ inputs.app-name }} \
            --force-new-deployment

      - name: Wait for Service Stability
        run: |
          aws ecs wait services-stable \
            --cluster tripalta-staging-cluster \
            --services ${{ inputs.app-name }}
        continue-on-error: true

  deploy-production:
    name: Deploy to Production
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build for Production
        run: npm run build
        env:
          VITE_API_BASE_URL: https://api.tripalta.com
          VITE_ENVIRONMENT: production

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/tripalta-production/${{ inputs.app-name }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/tripalta-production/${{ inputs.app-name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster tripalta-production-cluster \
            --service ${{ inputs.app-name }} \
            --force-new-deployment

      - name: Wait for Service Stability
        run: |
          aws ecs wait services-stable \
            --cluster tripalta-production-cluster \
            --services ${{ inputs.app-name }}
        continue-on-error: true
